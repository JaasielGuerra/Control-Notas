<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" class="has-background-light has-navbar-fixed-top">

<!-- aqui va el head -->
<head th:replace="layout/head :: head"></head>

<body>
<main>
    <div th:replace="layout/pageloader :: #pageloader"></div>

    <!-- aqui va el nav -->
    <nav th:replace="layout/nav :: nav"></nav>

    <section class="section">
        <div class="container">
            <div class="card">
                <div class="card-content">
                    <div class="content">

                        <h4 class="title has-text-centered is-4">DATOS INSTITUCIÓN</h4>
                        <hr class="dropdown-divider">
                        <!-- AQUI VA EL CONTENIDO DE CAMBIA -->
                        <form id="form-institucion">
                            <input type="hidden" id="id-institucion" th:value="${institucion.id}">
                            <p class="subtitle is-5 has-text-danger">* indica un campo obligatorio</p>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>*Código</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Código" required name="codigo"
                                               th:value="${institucion.codigo}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>*Nombre institución</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Nombre" required name="nombre"
                                               th:value="${institucion.nombre}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>Dirección</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Dirección" name="direccion"
                                               th:value="${institucion.direccion}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>Correo</label>
                                    <div class="control">
                                        <input class="input" type="email" placeholder="Correo" name="correo"
                                               th:value="${institucion.correo}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>Teléfono</label><br>
                                    <div class="control">
                                        <input class="input" type="tel" placeholder="Teléfono" name="telefono"
                                               th:value="${institucion.telefono}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>Nivel</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Nivel" name="nivel"
                                               th:value="${institucion.nivel}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>Sector</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Sector" name="sector"
                                               th:value="${institucion.sector}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>*Nombre director</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Nombre director" required
                                               name="nombreDirector" th:value="${institucion.nombreDirector}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-6">
                                    <label>Jornada</label>
                                    <div class="control">
                                        <input class="input" type="text" placeholder="Jornada" name="jornada"
                                               th:value="${institucion.jornada}">
                                    </div>
                                </div>
                            </div>
                            <div class="columns">
                                <div class="column is-3 is-offset-5 ">
                                    <button class="button  is-success is-large is-fullwidth" type="submit"
                                            id="btn-submit">
                                        <i class="far fa-save mr-1"></i> Guardar datos
                                    </button>
                                </div>
                            </div>
                        </form>
                        <!-- AQUI VA EL CONTENIDO DE CAMBIA -->
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- aqui va el footer-->
    <footer th:replace="layout/footer :: footer"></footer>

</main>


<!-- aqui va el script de jquery-->
<script th:replace="layout/scripts :: script"></script>

<!-- para validar formulario -->
<script src="/js/jquery.validate.min.js"></script>

<!-- utilidades -->
<script src="/js/utilidades.js"></script>

<script type="text/javascript">
    //function wrapper
    (function () {

        function guardarDatosInst(form) {

            let datosInstitucion = formToJSON(form);
            let idInstitucion = $('#id-institucion').val();

            $.ajax({
                url: '/institucion/' + idInstitucion,
                type: 'PUT',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(datosInstitucion),
                success: function (data) {
                    //si el code es 1
                    if (data.code === 1) {

                        //guardar mensaje de exito en el local storage
                        localStorage.setItem('messageSuccess', data.message);
                        location.reload();
                    }
                    //si el code es 0
                    else if (data.code === 0) {
                        showMessageError(data.message);
                        //recorrer los errores, concatenarlos
                        let errores = '';
                        $.each(data.errors, function (i, error) {
                            errores += error + '<br>';
                        });
                        //mostrar errores
                        showMessageError(errores);
                    }
                },
                error: function (xhr, status, error) {
                    showMessageError('Se produjo un error en el servidor ' + xhr.responseText);
                }
            });

        }

        // validar el formulario
        $('#form-institucion').validate({
            errorClass: 'is-danger',
            validClass: 'is-success',
            errorElement: 'p',
            rules: {
                codigo: {
                    required: true,
                    minlength: 10,
                    maxlength: 13
                },
                nombre: {
                    required: true,
                    minlength: 10,
                    maxlength: 100
                },
                direccion: {
                    minlength: 10,
                    maxlength: 80
                },
                correo: {
                    email: true,
                    minlength: 10,
                    maxlength: 50
                },
                telefono: {
                    minlength: 8,
                    maxlength: 8
                },
                nivel: {
                    minlength: 5,
                    maxlength: 15
                },
                sector: {
                    minlength: 5,
                    maxlength: 15
                },
                nombreDirector: {
                    required: true,
                    minlength: 3,
                    maxlength: 50
                },
                jornada: {
                    minlength: 5,
                    maxlength: 15
                }
            },
            messages: {
                codigo: {
                    required: "El código es obligatorio",
                    minlength: "El código debe tener al menos 10 caracteres",
                    maxlength: "El código debe tener máximo 13 caracteres"
                },
                nombre: {
                    required: "El nombre es obligatorio",
                    minlength: "El nombre debe tener al menos 10 caracteres",
                    maxlength: "El nombre debe tener máximo 100 caracteres"
                },
                direccion: {
                    minlength: "La dirección debe tener al menos 10 caracteres",
                    maxlength: "La dirección debe tener máximo 80 caracteres"
                },
                correo: {
                    email: "El correo no es válido, el formato debe ser name@domain.com",
                    minlength: "El correo debe tener al menos 10 caracteres",
                    maxlength: "El correo debe tener máximo 50 caracteres"
                },
                telefono: {
                    minlength: "El teléfono debe tener al menos 8 caracteres",
                    maxlength: "El teléfono debe tener máximo 8 caracteres"
                },
                nivel: {
                    minlength: "El nivel debe tener al menos 5 caracteres",
                    maxlength: "El nivel debe tener máximo 15 caracteres"
                },
                sector: {
                    minlength: "El sector debe tener al menos 5 caracteres",
                    maxlength: "El sector debe tener máximo 15 caracteres"
                },
                nombreDirector: {
                    required: "El nombre del director es obligatorio",
                    minlength: "El nombre del director debe tener al menos 3 caracteres",
                    maxlength: "El nombre del director debe tener máximo 50 caracteres"
                },
                jornada: {
                    minlength: "La jornada debe tener al menos 5 caracteres",
                    maxlength: "La jornada debe tener máximo 15 caracteres"
                }

            },
            errorPlacement: function (error, element) {
                // Add the `help` class to the error element
                error.addClass("help");
                error.insertAfter(element);
            },
            submitHandler: function (form) {
                // aqui va el codigo para guardar los datos
                guardarDatosInst(form);
            }
        });


        //cuando se carge el documento verificar si hay un mensaje de exito en el local storage y mostrarlo
        $(document).ready(function () {
            let messageSuccess = localStorage.getItem('messageSuccess');
            if (messageSuccess) {
                showMessageSuccess(messageSuccess);
                localStorage.removeItem('messageSuccess');
            }
        });


    })();


</script>

</body>
</html>